<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống AI Hotline cho Toà Nhà 174</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            text-align: center;
            background-color: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .description {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .record-button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .record-button:hover {
            background-color: #45a049;
        }

        .record-button.recording {
            background-color: #f44336;
        }

        .instructions {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .status {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 5px;
            text-align: left;
        }
        
        #transcription, #response {
            margin: 10px 0;
            line-height: 1.4;
        }
        
        #responseAudio {
            width: 100%;
            margin-top: 15px;
            display: none;
        }
        
        .record-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Hotline cho Toà Nhà 174</h1>
        
        <div class="description">
            <p>Chào mừng bạn đến với hệ thống trò chuyện bằng giọng nói thông minh. Hệ thống này cho phép bạn đặt câu hỏi bằng tiếng Việt và nhận câu trả lời tự động bằng giọng nói.</p>
            
            <p>Hệ thống sử dụng công nghệ nhận dạng giọng nói tiên tiến để chuyển đổi giọng nói của bạn thành văn bản, xử lý thông tin bằng trí tuệ nhân tạo, và chuyển đổi câu trả lời thành giọng nói tự nhiên.</p>
            
            <p>Hãy thử đặt câu hỏi và trải nghiệm cuộc trò chuyện thú vị!</p>
        </div>

        <button id="recordButton" class="record-button">Bắt đầu ghi âm</button>

        <div class="instructions">
            <h3>Cách sử dụng:</h3>
            <ol style="text-align: left;">
                <li>Nhấn nút "Bắt đầu ghi âm" để bắt đầu ghi âm</li>
                <li>Nói câu hỏi của bạn bằng tiếng Việt</li>
                <li>Nhấn lại nút để dừng ghi âm</li>
                <li>Đợi hệ thống AI xử lý và trả lời</li>
                <li>Nghe câu trả lời được tổng hợp</li>
            </ol>
        </div>

        <div id="status" class="status" style="margin-top: 20px; display: none;">
            <p id="transcription"></p>
            <p id="response"></p>
            <audio id="responseAudio" controls autoplay style="display: none;"></audio>
            <p id="audioStatus" style="color: #666; font-size: 14px;"></p>
        </div>
    </div>

    <script>
        let isRecording = false;

        $('#recordButton').click(function() {
            isRecording = !isRecording;
            const $status = $('#status');
            const $button = $(this);
            
            if (isRecording) {
                $button.text('Stop Recording');
                $button.addClass('recording');
                $status.hide();
                
                $.ajax({
                    url: '/start_recording',
                    method: 'POST',
                    success: function(response) {
                        console.log('Recording started:', response);
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        isRecording = false;
                        $button.text('Start Recording').removeClass('recording');
                    }
                });
            } else {
                $button.text('Start Recording');
                $button.removeClass('recording');
                $button.prop('disabled', true);  // Disable button during processing
                
                $.ajax({
                    url: '/stop_recording',
                    method: 'POST',
                    success: function(response) {
                        console.log('Recording stopped:', response);
                        
                        if (response.transcribed_text) {
                            $('#transcription').html('<strong>Bạn nói:</strong> ' + response.transcribed_text);
                            $('#response').html('<strong>Trả lời:</strong> ' + response.response_text);
                            
                            const audio = $('#responseAudio');
                            const audioStatus = $('#audioStatus');
                            
                            // Clear previous audio
                            audio.get(0).pause();
                            audio.get(0).currentTime = 0;
                            
                            // Set new source with timestamp to prevent caching
                            const timestamp = new Date().getTime();
                            audio.attr('src', `/audio/response.mp3?t=${timestamp}`);
                            
                            // Add event listeners for audio
                            audio.on('loadeddata', function() {
                                console.log('Audio loaded successfully');
                                audioStatus.text('Trả lời đang phát...');
                                
                                // Try to play and handle any autoplay restrictions
                                const playPromise = audio.get(0).play();
                                
                                if (playPromise !== undefined) {
                                    playPromise.then(_ => {
                                        console.log('Autoplay started');
                                    }).catch(error => {
                                        console.error('Autoplay prevented:', error);
                                        audioStatus.text('Nhấn vào nút play để nghe trả lời');
                                        audio.show(); // Make sure audio controls are visible
                                    });
                                }
                            });
                            
                            audio.on('ended', function() {
                                audioStatus.text('Trả lời đã kết thúc');
                            });
                            
                            audio.on('error', function(e) {
                                console.error('Audio loading error:', e);
                                audioStatus.text('Lỗi phát âm thanh. Vui lòng thử lại.');
                            });
                            
                            audio.show();
                            $('#status').show();
                        }
                        $button.prop('disabled', false);  // Re-enable button
                    },
                    error: function(error) {
                        console.error('Error:', error);
                        $button.prop('disabled', false);  // Re-enable button
                    }
                });
            }
        });
    </script>
</body>
</html> 